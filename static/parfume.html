<!doctype html>
<html lang="kz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>ZHAD parfume | Парфюм каталогы</title>

  <style>
    :root {
      /* Luxury Lumen color system - Uber-like, frameless, black & white with subtle gold accents */
      --lumen-black: #0b0b0b;
      --lumen-dark: #0d0d0d;
      --lumen-gray-950: #0f0f10;
      --lumen-gray-900: #151515;
      --lumen-gray-850: #1b1b1b;
      --lumen-gray-800: #1f1f1f;
      --lumen-gray-700: #2a2a2a;
      --lumen-gray-600: #3a3a3a;
      --lumen-gray-500: #525252;
      --lumen-gray-400: #6b6b6b;
      --lumen-gray-300: #8a8a8a;
      --lumen-white: #ffffff;

      --lumen-gold: #d4af37;
      --lumen-gold-light: #e6c766;
      --lumen-gold-dark: #a78728;
      --lumen-gold-glow: rgba(212, 175, 55, 0.28);

      --uber-green: #22c55e;
      --uber-red: #ef4444;
      --uber-orange: #f97316;
      --uber-gray-400: #6b6b6b;

      --bg-primary: var(--lumen-black);
      --bg-secondary: var(--lumen-gray-900);
      --bg-elevated: var(--lumen-gray-850);
      --bg-card: var(--lumen-gray-800);
      --text-primary: var(--lumen-white);
      --text-secondary: var(--lumen-gold);
      --text-muted: var(--lumen-gray-400);
      --border-subtle: #202020;
      --border-strong: #2a2a2a;
      --accent: var(--lumen-gold);
      --accent-hover: var(--lumen-gold-light);

      --shadow-sm: 0 1px 2px rgba(0,0,0,0.35);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.4);
      --shadow-lg: 0 10px 30px rgba(0,0,0,0.5);
      --shadow-glow: 0 0 20px var(--lumen-gold-glow);

      --tg-viewport-height: 100vh;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      height: 100%;
      overflow-x: hidden;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, 'Helvetica Neue', Arial, sans-serif;
      height: var(--tg-viewport-stable-height, 100vh);
      min-height: var(--tg-viewport-stable-height, 100vh);
      padding-top: calc(var(--tg-safe-area-inset-top, 0px) + var(--tg-content-safe-area-inset-top, 0px) + 15px);
      padding-bottom: calc(var(--tg-safe-area-inset-bottom, 0px) + 12px);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .app-container {
      height: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
      background: linear-gradient(180deg, var(--bg-primary), var(--bg-secondary));
    }

    /* Quantity Notice */
    .quantity-notice {
      background: linear-gradient(135deg, var(--lumen-gold), var(--lumen-gold-light));
      color: var(--lumen-black);
      padding: 12px 16px;
      text-align: center;
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 8px;
      border-radius: 8px;
      margin: 16px;
      box-shadow: var(--shadow-glow);
    }

    /* Restored Selection Notice */
    .restored-notice {
      background: linear-gradient(135deg, var(--uber-green), #16a085);
      color: white;
      padding: 12px 16px;
      text-align: center;
      font-weight: 600;
      font-size: 14px;
      margin: 16px;
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(34, 197, 94, 0.3);
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }

    .restored-notice.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* Access Restored Notice for users who lost permission */
    .access-restored-notice {
      background: linear-gradient(135deg, var(--uber-orange), #ea580c);
      color: white;
      padding: 16px;
      text-align: center;
      font-weight: 600;
      margin: 16px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(249, 115, 22, 0.3);
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }

    .access-restored-notice.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* Warning Alert */
    .warning-alert {
      background: linear-gradient(135deg, var(--uber-orange), #ea580c);
      color: white;
      padding: 16px;
      text-align: center;
      font-weight: 600;
      margin: 16px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(249, 115, 22, 0.3);
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }

    .warning-alert.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* Header */
    .header {
      background: linear-gradient(180deg, rgba(0,0,0,0.7), rgba(0,0,0,0.4));
      padding: 10px 16px 12px;
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      backdrop-filter: saturate(150%) blur(8px);
      -webkit-backdrop-filter: saturate(150%) blur(8px);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    .header-left { display: flex; align-items: center; gap: 12px; }
    .header-title {
      font-size: 22px;
      font-weight: 800;
      letter-spacing: 0.08em;
      color: var(--text-primary);
    }
    .header-subtitle { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

    .header-right { display: flex; align-items: center; gap: 10px; }

    /* Language Switch */
    .lang-switch {
      background: rgba(255,255,255,0.04);
      border-radius: 999px;
      display: flex;
      padding: 4px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .lang-btn {
      padding: 6px 12px;
      border: none;
      background: transparent;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-muted);
    }
    .lang-btn.active { background: var(--text-primary); color: var(--lumen-black); }

    /* Selection Counter */
    .selection-counter {
      position: relative;
      background: #121212;
      color: var(--text-primary);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 10px;
      border-radius: 12px;
      width: 44px; height: 44px;
      cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;
      transition: transform .15s ease, background .2s ease;
    }
    .selection-counter:active { transform: scale(0.97); }
    .selection-badge {
      position: absolute; top: -6px; right: -6px;
      background: var(--accent);
      color: #0a0a0a;
      border: 2px solid #0a0a0a;
      border-radius: 999px; width: 22px; height: 22px;
      font-size: 11px; font-weight: 800; display: flex; align-items: center; justify-content: center; min-width: 22px;
      box-shadow: var(--shadow-glow);
    }

    /* Limit Status Bar */
    .limit-status {
      background: rgba(255,255,255,0.04);
      padding: 8px 16px;
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    .limit-status.warning {
      background: rgba(249, 115, 22, 0.1);
      color: var(--uber-orange);
    }

    .limit-status.danger {
      background: rgba(239, 68, 68, 0.1);
      color: var(--uber-red);
    }

    /* Search */
    .search-container { padding: 14px 16px 12px; background: transparent; }
    .search-wrapper { position: relative; }
    .search-input {
      width: 100%; padding: 12px 16px 12px 44px;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px; font-size: 16px; background: #111213; color: var(--text-primary);
      outline: none; transition: border-color .2s, box-shadow .2s, background .2s;
    }
    .search-input:focus { border-color: rgba(255,255,255,0.16); box-shadow: 0 0 0 6px rgba(255,255,255,0.04); background: #121315; }
    .search-input::placeholder { color: var(--text-muted); }
    .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); opacity: .9; }

    /* Filter Pills */
    .filter-container {
      padding: 2px 16px 12px; display: flex; gap: 8px; overflow-x: auto; -webkit-overflow-scrolling: touch;
    }
    .filter-pill {
      padding: 8px 14px; background: #111213; border: 1px solid rgba(255,255,255,0.08);
      border-radius: 999px; font-size: 13px; font-weight: 700; cursor: pointer; transition: background .2s, border-color .2s, color .2s; white-space: nowrap; flex-shrink: 0; color: var(--text-primary);
    }
    .filter-pill:hover { background: #151619; border-color: rgba(255,255,255,0.14); }
    .filter-pill.active { background: var(--text-primary); color: #0a0a0a; border-color: var(--text-primary); }

    /* Product List */
    .product-list { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; background: transparent; }
    .product-count { padding: 10px 16px; font-size: 13px; color: var(--text-muted); border-bottom: 1px solid rgba(255,255,255,0.06); backdrop-filter: blur(4px); }

    .product-item {
      display: flex; padding: 14px; border-bottom: 1px solid rgba(255,255,255,0.06);
      cursor: pointer; transition: background .25s, transform .2s ease;
      gap: 12px; background: transparent; margin: 0; border-radius: 0;
      position: relative;
    }
    .product-item:hover { background: rgba(255,255,255,0.02); }
    .product-item:active { transform: scale(0.998); }
    .product-item.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    .product-image { width: 84px; height: 84px; border-radius: 12px; background: #131415; flex-shrink: 0; border: 1px solid rgba(255,255,255,0.08); overflow: hidden; display: flex; align-items: center; justify-content: center; }
    .product-image img { width: 100%; height: 100%; object-fit: cover; border-radius: inherit; display: none; }
    .image-placeholder { font-size: 28px; color: var(--text-secondary); opacity: .9; }

    .product-info { flex: 1; display: flex; flex-direction: column; gap: 6px; }
    .product-name { font-size: 16px; font-weight: 800; color: var(--text-primary); line-height: 1.25; }
    .product-sex { font-size: 11px; color: #0a0a0a; background: var(--text-primary); padding: 2px 8px; border-radius: 999px; width: fit-content; font-weight: 800; }
    .product-description { font-size: 13px; color: var(--text-muted); line-height: 1.45; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

    .product-actions { display: flex; align-items: center; justify-content: space-between; margin-top: 6px; }
    .product-price { font-size: 18px; font-weight: 900; color: var(--text-primary); }
    .product-price-unit { font-size: 12px; font-weight: 500; color: var(--text-muted); }

    /* Quantity Controls */
    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.05);
      padding: 6px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.08);
    }

    .quantity-btn {
      width: 28px;
      height: 28px;
      background: var(--text-primary);
      color: #0a0a0a;
      border: none;
      border-radius: 50%;
      font-size: 16px;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .quantity-btn:hover:not(:disabled) {
      transform: scale(1.05);
    }

    .quantity-btn:active:not(:disabled) {
      transform: scale(0.95);
    }

    .quantity-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      transform: none;
      background: var(--lumen-gray-600);
    }

    .quantity-value {
      font-size: 14px;
      font-weight: 800;
      min-width: 20px;
      text-align: center;
      color: var(--text-primary);
    }

    /* Continue Button */
    .continue-btn {
      position: fixed;
      bottom: calc(16px + var(--tg-safe-area-inset-bottom, 0px));
      left: 16px;
      right: 16px;
      background: linear-gradient(135deg, var(--uber-green), #16a085);
      color: white;
      border: none;
      padding: 16px;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 900;
      cursor: pointer;
      z-index: 40;
      box-shadow: 0 14px 36px rgba(34, 197, 94, 0.4);
      transition: transform .28s ease, opacity .28s ease;
      transform: translateY(120px);
      opacity: 0;
    }

    .continue-btn.show {
      transform: translateY(0);
      opacity: 1;
    }

    .continue-btn:active {
      transform: translateY(0) scale(0.98);
    }

    /* Loading & Empty States */
    .loading { display: flex; align-items: center; justify-content: center; padding: 40px; color: var(--text-secondary); }
    .loading-spinner { width: 28px; height: 28px; border: 3px solid rgba(255,255,255,0.12); border-top-color: var(--text-primary); border-radius: 50%; animation: spin .8s linear infinite; margin-right: 12px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; text-align: center; }
    .empty-icon { font-size: 56px; margin-bottom: 12px; opacity: 0.75; }
    .empty-title { font-size: 18px; font-weight: 900; margin-bottom: 6px; }
    .empty-subtitle { font-size: 14px; color: var(--text-muted); }

    /* No Quantity Alert */
    .no-quantity-alert {
      background: linear-gradient(135deg, var(--uber-red), #c53030);
      color: white;
      padding: 16px;
      text-align: center;
      font-weight: 600;
      margin: 16px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(239, 68, 68, 0.3);
    }

    /* Utilities */
    .hidden { display: none !important; }

    /* Mobile Optimizations */
    @media (max-width: 480px) {
      .header { padding: 10px 16px 10px; }
      .header-title { font-size: 20px; }
      .product-image { width: 76px; height: 76px; }
      .continue-btn { bottom: calc(12px + var(--tg-safe-area-inset-bottom, 0px)); }
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--uber-gray-400); border-radius: 2px; }
  </style>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <div>
          <div class="header-title" id="headerTitle">ZHAD</div>
          <div class="header-subtitle" id="headerSubtitle">Парфюм каталогы</div>
        </div>
      </div>
      <div class="header-right">
        <div class="lang-switch">
          <button class="lang-btn" id="langRu" onclick="setLanguage('ru')">РУС</button>
          <button class="lang-btn active" id="langKz" onclick="setLanguage('kz')">ҚАЗ</button>
        </div>
        <button class="selection-counter">
          🛒
          <span class="selection-badge hidden" id="selectionBadge">0</span>
        </button>
      </div>
    </div>

    <!-- Limit Status -->
    <div class="limit-status" id="limitStatus">
      Таңдалды: <span id="selectedCount">0</span> / <span id="totalLimit">0</span>
    </div>

    <!-- Restored Selection Notice -->
    <div class="restored-notice hidden" id="restoredNotice">
      ✅ Сіздің бұрынғы таңдауыңыз қалпына келтірілді!
    </div>

    <!-- Access Restored Notice -->
    <div class="access-restored-notice hidden" id="accessRestoredNotice">
      🔄 Қайтып келгеніңізге қуаныштымыз! Сіздің таңдауларыңыз сақталды.
    </div>

    <!-- Warning Alert -->
    <div class="warning-alert hidden" id="warningAlert">
      ⚠️ Лимит асып кетті!
    </div>

    <!-- Quantity Notice -->
    <div class="quantity-notice hidden" id="quantityNotice">
      Сізде 0 парфюм таңдауға мүмкіндік бар
    </div>

    <!-- No Quantity Alert -->
    <div class="no-quantity-alert hidden" id="noQuantityAlert">
      😔 Сізде таңдауға болатын парфюм жоқ. Алдымен төлем жасаңыз.
    </div>

    <!-- Search -->
    <div class="search-container">
      <div class="search-wrapper">
        <span class="search-icon">🔍</span>
        <input type="text" class="search-input" id="searchInput" placeholder="Парфюм іздеу..." />
      </div>
    </div>

    <!-- Filters -->
    <div class="filter-container">
      <button class="filter-pill active" onclick="setFilter('all')" id="filterAll">Барлығы</button>
      <button class="filter-pill" onclick="setFilter('Male')" id="filterMale">Ерлерге</button>
      <button class="filter-pill" onclick="setFilter('Female')" id="filterFemale">Әйелдерге</button>
      <button class="filter-pill" onclick="setFilter('Unisex')" id="filterUnisex">Барлығына</button>
    </div>

    <!-- Product List -->
    <div class="product-list" id="productList">
      <div class="loading">
        <div class="loading-spinner"></div>
        <span id="loadingText">Парфюмдер жүктелуде...</span>
      </div>
    </div>

    <!-- Continue Button -->
    <button class="continue-btn" id="continueBtn" onclick="proceedToOrder()">
      ➡️ Жалғастыру
    </button>
  </div>

  <script>
    // Global Variables
    let currentLang = 'kz';
    let allPerfumes = [];
    let filteredPerfumes = [];
    let selectedPerfumes = {}; // {perfumeId: quantity}
    let availableQuantity = 0;
    let telegramId = null;
    let currentFilter = 'all';
    let accessWasRestored = false; // Track if we restored access
    let saveTimeout;
    let isCurrentlySaving = false;

    // Translations
    const translations = {
      ru: {
        title: 'ZHAD PARFUME',
        subtitle: 'Каталог парфюмерии',
        searchPlaceholder: 'Поиск парфюма...',
        loadingText: 'Загрузка парфюмов...',
        filterAll: 'Все',
        filterMale: 'Для мужчин',
        filterFemale: 'Для женщин',
        filterUnisex: 'Унисекс',
        quantityNotice: 'У вас есть возможность выбрать {count} парфюм(ов)',
        noQuantityAlert: '😔 У вас нет доступных парфюмов для выбора. Сначала оплатите заказ.',
        continueBtn: '➡️ Продолжить',
        items: 'товаров',
        male: 'Мужской',
        female: 'Женский',
        unisex: 'Унисекс',
        selectPerfumes: 'Выберите парфюмы',
        maxQuantityReached: 'Достигнуто максимальное количество парфюмов! Вы можете выбрать только {limit}.',
        limitExceeded: '⚠️ Превышен лимит! Вы можете выбрать только {limit} парфюм(ов).',
        limitStatus: 'Выбрано: {selected} / {limit}',
        emptySearchTitle: 'Ничего не найдено',
        emptySearchSubtitle: 'Попробуйте изменить поисковый запрос',
        warningAlert: '⚠️ Лимит превышен!',
        restoredNotice: '✅ Ваш предыдущий выбор восстановлен!',
        accessRestoredNotice: '🔄 Рады видеть вас снова! Ваши выборы сохранены.'
      },
      kz: {
        title: 'ZHAD PARFUME',
        subtitle: 'Парфюм каталогы',
        searchPlaceholder: 'Парфюм іздеу...',
        loadingText: 'Парфюмдер жүктелуде...',
        filterAll: 'Барлығы',
        filterMale: 'Ерлерге',
        filterFemale: 'Әйелдерге',
        filterUnisex: 'Барлығына',
        quantityNotice: 'Сізде {count} парфюм таңдауға мүмкіндік бар',
        noQuantityAlert: '😔 Сізде таңдауға болатын парфюм жоқ. Алдымен төлем жасаңыз.',
        continueBtn: '➡️ Жалғастыру',
        items: 'тауар',
        male: 'Ерлер',
        female: 'Әйелдер',
        unisex: 'Барлығына',
        selectPerfumes: 'Парфюм таңдаңыз',
        maxQuantityReached: 'Максималды сан жетті! Сіз тек {limit} парфюм таңдай аласыз.',
        limitExceeded: '⚠️ Лимит асып кетті! Сіз тек {limit} парфюм таңдай аласыз.',
        limitStatus: 'Таңдалды: {selected} / {limit}',
        emptySearchTitle: 'Ештеңе табылмады',
        emptySearchSubtitle: 'Іздеу сөзін өзгертіп көріңіз',
        warningAlert: '⚠️ Лимит асып кетті!',
        restoredNotice: '✅ Сіздің бұрынғы таңдауыңыз қалпына келтірілді!',
        accessRestoredNotice: '🔄 Қайтып келгеніңізге қуаныштымыз! Сіздің таңдауларыңыз сақталды.'
      }
    };

    // Initialize Telegram WebApp
    function initTelegramWebApp() {
      console.log('🚀 Initializing ZHAD Perfume Selection...');
      
      if (!window.Telegram || !Telegram.WebApp) {
        console.warn('⚠️ Telegram WebApp not available');
        return false;
      }

      try {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        
        if (Telegram.WebApp.initDataUnsafe?.user) {
          telegramId = Telegram.WebApp.initDataUnsafe.user.id;
          console.log('📱 Telegram User ID:', telegramId);
        }

        try {
          Telegram.WebApp.setBackgroundColor('#0b0b0b');
          Telegram.WebApp.setHeaderColor('#000000');
        } catch (_) {}

        updateViewportHeight();
        Telegram.WebApp.onEvent('viewportChanged', updateViewportHeight);

        return true;
      } catch (error) {
        console.error('❌ Error initializing Telegram WebApp:', error);
        return false;
      }
    }

    // Update viewport height
    function updateViewportHeight() {
      let vh = window.innerHeight;
      if (window.Telegram && Telegram.WebApp) vh = Telegram.WebApp.viewportHeight || vh;
      document.documentElement.style.setProperty('--tg-viewport-height', `${vh}px`);
    }

    // Enhanced function to load available quantity and restore access if needed
    async function loadAvailableQuantity() {
      if (!telegramId) {
        console.warn('No Telegram ID available');
        showNoQuantityAlert();
        return;
      }

      try {
        console.log('📊 Loading available quantity from backend...');
        const response = await fetch(`/api/user/available-quantity?telegram_id=${telegramId}`);
        const data = await response.json();
        
        if (data.success) {
          console.log('💡 Backend response:', data);
          
          // Check if access was restored due to temporary selections
          if (data.access_restored) {
            console.log('🔄 ACCESS RESTORED: User had temporary selections, restoring access');
            availableQuantity = data.available_quantity;
            accessWasRestored = true;
            
            // Load and restore the temporary selections
            await loadAndRestoreTemporarySelections();
            
            showAccessRestoredNotice();
          } else if (data.has_temporary_selections) {
            console.log('📦 Found temporary selections, restoring...');
            availableQuantity = data.available_quantity;
            
            // Load and restore the temporary selections
            await loadAndRestoreTemporarySelections();
            
            showRestoredNotice();
          } else {
            // Normal flow - no temporary selections
            availableQuantity = data.available_quantity;
          }
          
          if (availableQuantity > 0) {
            showQuantityNotice(availableQuantity);
            updateLimitStatus();
            await loadPerfumes();
          } else {
            showNoQuantityAlert();
          }
        } else {
          console.error('❌ Backend error:', data);
          showNoQuantityAlert();
        }
      } catch (error) {
        console.error('❌ Error loading available quantity:', error);
        showNoQuantityAlert();
      }
    }

    // Load and restore temporary selections from backend
    async function loadAndRestoreTemporarySelections() {
      if (!telegramId) return;

      try {
        console.log('🔍 Loading temporary selections from backend...');
        const response = await fetch(`/api/user/temp-selections?telegram_id=${telegramId}`);
        const data = await response.json();
        
        if (data.success && data.has_temp_selections && data.selections.length > 0) {
          console.log('✅ Found temporary selections:', data.selections);
          
          // Clear current selections
          selectedPerfumes = {};
          
          // Restore each selection
          data.selections.forEach(selection => {
            if (selection.id && selection.quantity) {
              selectedPerfumes[selection.id] = selection.quantity;
              console.log(`Restored: ${selection.name} x${selection.quantity}`);
            }
          });
          
          // Update UI
          updateSelectionCounter();
          updateLimitStatus();
          
          console.log('🔄 Temporary selections restored to UI');
          return true;
        } else {
          console.log('📭 No temporary selections found');
          return false;
        }
      } catch (error) {
        console.error('❌ Error loading temporary selections:', error);
        return false;
      }
    }

    // Enhanced auto-save with better error handling and retry logic
    async function autoSaveSelection() {
      clearTimeout(saveTimeout);
      
      // Don't start a new save if one is already in progress
      if (isCurrentlySaving) {
        console.log('⏳ Save already in progress, scheduling retry...');
        saveTimeout = setTimeout(() => autoSaveSelection(), 2000);
        return;
      }
      
      saveTimeout = setTimeout(async () => {
        await saveTemporarySelectionWithRetry();
      }, 1000); // Save 1 second after last change
    }

    // Save temporary selection with retry logic
    async function saveTemporarySelectionWithRetry(maxRetries = 3) {
      if (!telegramId || isCurrentlySaving) return;

      isCurrentlySaving = true;
      
      const selectionData = [];
      for (const [perfumeId, quantity] of Object.entries(selectedPerfumes)) {
        const perfume = allPerfumes.find(p => p.Id === perfumeId);
        if (perfume) {
          selectionData.push({
            id: perfumeId,
            name: perfume.NameParfume,
            quantity: quantity
          });
        }
      }

      let retryCount = 0;
      
      while (retryCount < maxRetries) {
        try {
          console.log(`💾 Saving temporary selection (attempt ${retryCount + 1})...`);
          
          const response = await fetch('/api/user/save-perfume-selection', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              telegram_id: telegramId,
              selected_perfumes: selectionData
            }),
          });

          const result = await response.json();
          
          if (result.success) {
            console.log('✅ Temporary selection auto-saved successfully');
            
            // Check if this was a restored access save
            if (result.restored_access) {
              console.log('🔄 Access was restored during save');
            }
            
            isCurrentlySaving = false;
            return true;
          } else {
            throw new Error(result.message || 'Save failed');
          }
        } catch (error) {
          retryCount++;
          console.warn(`⚠️ Failed to auto-save selection (attempt ${retryCount}):`, error);
          
          if (retryCount < maxRetries) {
            // Wait before retrying (exponential backoff)
            const delay = Math.min(1000 * Math.pow(2, retryCount), 5000);
            console.log(`⏳ Retrying in ${delay}ms...`);
            await new Promise(resolve => setTimeout(resolve, delay));
          } else {
            console.error('❌ Failed to save selection after all retries');
            isCurrentlySaving = false;
            return false;
          }
        }
      }
      
      isCurrentlySaving = false;
      return false;
    }

    // Show quantity notice
    function showQuantityNotice(quantity) {
      const notice = document.getElementById('quantityNotice');
      const text = translations[currentLang].quantityNotice.replace('{count}', quantity);
      notice.textContent = text;
      notice.classList.remove('hidden');
    }

    // Show no quantity alert
    function showNoQuantityAlert() {
      const alert = document.getElementById('noQuantityAlert');
      alert.textContent = translations[currentLang].noQuantityAlert;
      alert.classList.remove('hidden');
      
      // Hide other elements
      document.querySelector('.search-container').style.display = 'none';
      document.querySelector('.filter-container').style.display = 'none';
      document.getElementById('limitStatus').style.display = 'none';
      document.getElementById('productList').innerHTML = '';
    }

    // Update limit status
    function updateLimitStatus() {
      const statusDiv = document.getElementById('limitStatus');
      const selectedCount = getTotalSelectedQuantity();
      
      const statusText = translations[currentLang].limitStatus
        .replace('{selected}', selectedCount)
        .replace('{limit}', availableQuantity);
      
      document.getElementById('selectedCount').textContent = selectedCount;
      document.getElementById('totalLimit').textContent = availableQuantity;
      
      // Update status styling based on selection
      statusDiv.className = 'limit-status';
      if (selectedCount === availableQuantity) {
        statusDiv.classList.add('warning');
      } else if (selectedCount > availableQuantity) {
        statusDiv.classList.add('danger');
      }
    }

    // Show warning alert
    function showWarningAlert(message) {
      const alert = document.getElementById('warningAlert');
      alert.textContent = message;
      alert.classList.remove('hidden');
      alert.classList.add('show');
      
      // Hide after 3 seconds
      setTimeout(() => {
        alert.classList.remove('show');
        setTimeout(() => {
          alert.classList.add('hidden');
        }, 300);
      }, 3000);
    }

    // Show restored selection notice
    function showRestoredNotice() {
      const notice = document.getElementById('restoredNotice');
      notice.textContent = translations[currentLang].restoredNotice;
      notice.classList.remove('hidden');
      notice.classList.add('show');
      
      // Hide after 4 seconds
      setTimeout(() => {
        notice.classList.remove('show');
        setTimeout(() => {
          notice.classList.add('hidden');
        }, 300);
      }, 4000);
    }

    // Show access restored notice for users who lost permission
    function showAccessRestoredNotice() {
      const notice = document.getElementById('accessRestoredNotice');
      if (notice) {
        notice.textContent = translations[currentLang].accessRestoredNotice;
        notice.classList.remove('hidden');
        notice.classList.add('show');
        
        // Hide after 6 seconds (longer since this is important)
        setTimeout(() => {
          notice.classList.remove('show');
          setTimeout(() => {
            notice.classList.add('hidden');
          }, 300);
        }, 6000);
      }
    }

    // Load perfumes from API
    async function loadPerfumes() {
      try {
        console.log('🌸 Loading perfumes from API...');
        const response = await fetch('/api/parfumes');
        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        
        allPerfumes = await response.json();
        filteredPerfumes = [...allPerfumes];
        renderPerfumes();
        
        console.log('✅ Perfumes loaded successfully');
      } catch (error) {
        console.error('❌ Error loading perfumes:', error);
        showEmptyState('error', 'Қате орын алды', 'Парфюмдерді жүктеу мүмкін болмады');
      }
    }

    // Render perfumes list
    function renderPerfumes() {
      const container = document.getElementById('productList');
      
      if (filteredPerfumes.length === 0) {
        showEmptyState('search');
        return;
      }

      let html = `<div class="product-count">${filteredPerfumes.length} ${translations[currentLang].items}</div>`;
      
      filteredPerfumes.forEach(perfume => {
        const photoUrl = perfume.PhotoPath ? `/photo/${perfume.PhotoPath}` : null;
        const sexLabel = getSexLabel(perfume.Sex);
        const selectedQuantity = selectedPerfumes[perfume.Id] || 0;
        const totalSelected = getTotalSelectedQuantity();
        const canIncrease = totalSelected < availableQuantity;
        const canDecrease = selectedQuantity > 0;
        
        const imageHtml = photoUrl ? 
          `<img src="${photoUrl}" alt="${escapeHtml(perfume.NameParfume)}" onload="this.style.display='block'" onerror="handleImageError(this)">` : 
          '<div class="image-placeholder">🌸</div>';
        
        html += `
          <div class="product-item" data-perfume-id="${perfume.Id}">
            <div class="product-image">${imageHtml}</div>
            <div class="product-info">
              <div class="product-name">${escapeHtml(perfume.NameParfume)}</div>
              <span class="product-sex">${sexLabel}</span>
              <div class="product-description">${escapeHtml(perfume.Description)}</div>
              <div class="product-actions">
                <div class="product-price">${perfume.Price} ₸</div>
                <div class="quantity-controls">
                  <button class="quantity-btn" onclick="changeQuantity('${perfume.Id}', -1)" ${!canDecrease ? 'disabled' : ''}>−</button>
                  <span class="quantity-value">${selectedQuantity}</span>
                  <button class="quantity-btn" onclick="changeQuantity('${perfume.Id}', 1)" ${!canIncrease ? 'disabled' : ''}>+</button>
                </div>
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // Enhanced change quantity with better state management
    function changeQuantity(perfumeId, change) {
      const currentQuantity = selectedPerfumes[perfumeId] || 0;
      const newQuantity = currentQuantity + change;
      const currentTotalSelected = getTotalSelectedQuantity();
      const newTotalSelected = currentTotalSelected + change;
      
      console.log(`Changing quantity for ${perfumeId}: ${currentQuantity} -> ${newQuantity}`);
      console.log(`Total selection: ${currentTotalSelected} -> ${newTotalSelected} (limit: ${availableQuantity})`);
      
      // Validation checks
      if (newQuantity < 0) {
        console.log('Cannot go below 0');
        return;
      }
      
      // Check if trying to increase beyond limit
      if (change > 0 && newTotalSelected > availableQuantity) {
        console.log('Limit exceeded, showing warning');
        const warningMessage = translations[currentLang].limitExceeded.replace('{limit}', availableQuantity);
        showWarningAlert(warningMessage);
        
        // Also show Telegram alert
        if (window.Telegram && Telegram.WebApp) {
          const alertMessage = translations[currentLang].maxQuantityReached.replace('{limit}', availableQuantity);
          Telegram.WebApp.showAlert(alertMessage);
        }
        return;
      }
      
      // Update the quantity
      if (newQuantity === 0) {
        delete selectedPerfumes[perfumeId];
        console.log(`Removed ${perfumeId} from selection`);
      } else {
        selectedPerfumes[perfumeId] = newQuantity;
        console.log(`Set ${perfumeId} quantity to ${newQuantity}`);
      }
      
      // Auto-save temporary selection (with debouncing)
      autoSaveSelection();
      
      // Update UI
      updateSelectionCounter();
      updateLimitStatus();
      renderPerfumes(); // Re-render to update button states
    }

    // Get total selected quantity
    function getTotalSelectedQuantity() {
      return Object.values(selectedPerfumes).reduce((sum, qty) => sum + qty, 0);
    }

    // Update selection counter
    function updateSelectionCounter() {
      const badge = document.getElementById('selectionBadge');
      const continueBtn = document.getElementById('continueBtn');
      const totalSelected = getTotalSelectedQuantity();
      
      console.log(`Updating selection counter: ${totalSelected} items selected`);
      
      if (totalSelected > 0) {
        badge.textContent = totalSelected;
        badge.classList.remove('hidden');
        continueBtn.classList.add('show');
      } else {
        badge.classList.add('hidden');
        continueBtn.classList.remove('show');
      }
    }

    // Show empty state
    function showEmptyState(type, customTitle = null, customSubtitle = null) {
      const container = document.getElementById('productList');
      let icon, title, subtitle;
      
      if (type === 'search') {
        icon = '🔍';
        title = customTitle || translations[currentLang].emptySearchTitle;
        subtitle = customSubtitle || translations[currentLang].emptySearchSubtitle;
      } else if (type === 'error') {
        icon = '⚠️';
        title = customTitle || 'Қате орын алды';
        subtitle = customSubtitle || 'Парфюмдерді жүктеу мүмкін болмады';
      }
      
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">${icon}</div>
          <div class="empty-title">${title}</div>
          <div class="empty-subtitle">${subtitle}</div>
        </div>
      `;
    }

    // Get sex label
    function getSexLabel(sex) {
      const labels = {
        'Male': translations[currentLang].male,
        'Female': translations[currentLang].female,
        'Unisex': translations[currentLang].unisex
      };
      return labels[sex] || sex;
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Handle image error
    function handleImageError(img) {
      const container = img.parentElement;
      container.innerHTML = '<div class="image-placeholder">🌸</div>';
    }

    // Set filter
    function setFilter(filter) {
      currentFilter = filter;
      
      document.querySelectorAll('.filter-pill').forEach(btn => btn.classList.remove('active'));
      event.currentTarget.classList.add('active');
      
      if (filter === 'all') {
        filteredPerfumes = [...allPerfumes];
      } else {
        filteredPerfumes = allPerfumes.filter(p => p.Sex === filter);
      }
      
      const searchTerm = document.getElementById('searchInput').value.trim();
      if (searchTerm) {
        searchPerfumes(searchTerm);
      } else {
        renderPerfumes();
      }
    }

    // Search perfumes
    function searchPerfumes(query) {
      const searchTerm = query.toLowerCase();
      const baseList = currentFilter === 'all' ? allPerfumes : allPerfumes.filter(p => p.Sex === currentFilter);
      
      filteredPerfumes = baseList.filter(perfume => 
        (perfume.NameParfume || '').toLowerCase().includes(searchTerm) || 
        (perfume.Description || '').toLowerCase().includes(searchTerm)
      );
      
      renderPerfumes();
    }

    // Enhanced proceed to order with better validation
    async function proceedToOrder() {
      const totalSelected = getTotalSelectedQuantity();
      if (totalSelected === 0) {
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.showAlert(translations[currentLang].selectPerfumes);
        }
        return;
      }

      // Final validation before proceeding
      if (totalSelected > availableQuantity) {
        const warningMessage = translations[currentLang].limitExceeded.replace('{limit}', availableQuantity);
        showWarningAlert(warningMessage);
        if (window.Telegram && Telegram.WebApp) {
          const alertMessage = translations[currentLang].maxQuantityReached.replace('{limit}', availableQuantity);
          Telegram.WebApp.showAlert(alertMessage);
        }
        return;
      }

      // Prepare selection data
      const selectionData = [];
      for (const [perfumeId, quantity] of Object.entries(selectedPerfumes)) {
        const perfume = allPerfumes.find(p => p.Id === perfumeId);
        if (perfume) {
          selectionData.push({
            id: perfumeId,
            name: perfume.NameParfume,
            quantity: quantity
          });
        }
      }

      console.log('Proceeding to order with selection:', selectionData);

      try {
        // Force save final selection to backend before redirecting
        isCurrentlySaving = true; // Prevent auto-save conflicts
        
        const response = await fetch('/api/user/save-perfume-selection', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            telegram_id: telegramId,
            selected_perfumes: selectionData
          }),
        });

        const result = await response.json();
        
        if (result.success) {
          console.log('✅ Final selection saved successfully');
          
          // Small delay to ensure save is complete
          setTimeout(() => {
            window.location.href = '/order';
          }, 500);
        } else {
          throw new Error(result.message || 'Failed to save selection');
        }
      } catch (error) {
        console.error('❌ Error saving selection:', error);
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.showAlert('Қате орын алды: ' + error.message);
        }
      } finally {
        isCurrentlySaving = false;
      }
    }

    // Set language
    function setLanguage(lang) {
      currentLang = lang;
      
      document.getElementById('langRu').classList.toggle('active', lang === 'ru');
      document.getElementById('langKz').classList.toggle('active', lang === 'kz');
      
      document.getElementById('headerTitle').textContent = translations[lang].title;
      document.getElementById('headerSubtitle').textContent = translations[lang].subtitle;
      document.getElementById('searchInput').placeholder = translations[lang].searchPlaceholder;
      document.getElementById('loadingText').textContent = translations[lang].loadingText;
      document.getElementById('continueBtn').innerHTML = translations[lang].continueBtn;
      
      document.getElementById('filterAll').textContent = translations[lang].filterAll;
      document.getElementById('filterMale').textContent = translations[lang].filterMale;
      document.getElementById('filterFemale').textContent = translations[lang].filterFemale;
      document.getElementById('filterUnisex').textContent = translations[lang].filterUnisex;
      
      // Update quantity notice if visible
      if (availableQuantity > 0) {
        showQuantityNotice(availableQuantity);
        updateLimitStatus();
      }
      
      // Update no quantity alert if visible
      if (!document.getElementById('noQuantityAlert').classList.contains('hidden')) {
        document.getElementById('noQuantityAlert').textContent = translations[lang].noQuantityAlert;
      }
      
      if (filteredPerfumes.length > 0) {
        renderPerfumes();
      }
    }

    // Search input handler
    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('searchInput');
      let searchTimeout;
      
      searchInput.addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();
        
        searchTimeout = setTimeout(() => {
          if (query.length === 0) {
            filteredPerfumes = currentFilter === 'all' ? [...allPerfumes] : allPerfumes.filter(p => p.Sex === currentFilter);
          } else {
            searchPerfumes(query);
          }
          renderPerfumes();
        }, 300);
      });
    });

    // Handle page visibility changes to save selections
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        // Page is being hidden - force save selections
        console.log('🔄 Page hidden, force saving selections...');
        if (Object.keys(selectedPerfumes).length > 0) {
          // Force immediate save without debouncing
          clearTimeout(saveTimeout);
          saveTemporarySelectionWithRetry(1); // Single attempt for immediate save
        }
      }
    });

    // Handle beforeunload to save selections
    window.addEventListener('beforeunload', function(e) {
      if (Object.keys(selectedPerfumes).length > 0 && !isCurrentlySaving) {
        console.log('🔄 Page unloading, attempting to save selections...');
        // Try synchronous save (may not always work due to browser limitations)
        navigator.sendBeacon && navigator.sendBeacon('/api/user/save-perfume-selection', 
          JSON.stringify({
            telegram_id: telegramId,
            selected_perfumes: Object.entries(selectedPerfumes).map(([id, qty]) => {
              const perfume = allPerfumes.find(p => p.Id === id);
              return perfume ? { id, name: perfume.NameParfume, quantity: qty } : null;
            }).filter(Boolean)
          })
        );
      }
    });

    // Initialize app
    async function init() {
      console.log('🚀 Initializing ZHAD Perfume Selection...');
      
      initTelegramWebApp();
      setLanguage('kz');
      
      // Load available quantity first, which will also handle temporary selections
      await loadAvailableQuantity();
      
      window.addEventListener('resize', updateViewportHeight);
      
      console.log('✅ Perfume selection ready!');
    }

    // Start app
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    // Prevent double-tap zoom
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(e) {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) {
        e.preventDefault();
      }
      lastTouchEnd = now;
    }, { passive: false });
  </script>
</body>
</html>