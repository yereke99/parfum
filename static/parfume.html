<!doctype html>
<html lang="kz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>ZHAD parfume | Парфюм каталогы</title>

  <style>
    :root {
      /* Luxury Lumen color system - Uber-like, frameless, black & white with subtle gold accents */
      --lumen-black: #0b0b0b;
      --lumen-dark: #0d0d0d;
      --lumen-gray-950: #0f0f10;
      --lumen-gray-900: #151515;
      --lumen-gray-850: #1b1b1b;
      --lumen-gray-800: #1f1f1f;
      --lumen-gray-700: #2a2a2a;
      --lumen-gray-600: #3a3a3a;
      --lumen-gray-500: #525252;
      --lumen-gray-400: #6b6b6b;
      --lumen-gray-300: #8a8a8a;
      --lumen-white: #ffffff;

      --lumen-gold: #d4af37; /* subtler, more premium than bright gold */
      --lumen-gold-light: #e6c766;
      --lumen-gold-dark: #a78728;
      --lumen-gold-glow: rgba(212, 175, 55, 0.28);

      /* Accents (needed by logic references) */
      --uber-green: #22c55e; /* used for add-to-cart instant feedback */
      --uber-gray-400: #6b6b6b; /* used in custom scrollbar */

      /* Theme tokens */
      --bg-primary: var(--lumen-black);
      --bg-secondary: var(--lumen-gray-900);
      --bg-elevated: var(--lumen-gray-850);
      --bg-card: var(--lumen-gray-800);
      --text-primary: var(--lumen-white);
      --text-secondary: var(--lumen-gold);
      --text-muted: var(--lumen-gray-400);
      --border-subtle: #202020;
      --border-strong: #2a2a2a;
      --accent: var(--lumen-gold);
      --accent-hover: var(--lumen-gold-light);

      --shadow-sm: 0 1px 2px rgba(0,0,0,0.35);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.4);
      --shadow-lg: 0 10px 30px rgba(0,0,0,0.5);
      --shadow-glow: 0 0 20px var(--lumen-gold-glow);

      /* Telegram viewport height fallback */
      --tg-viewport-height: 100vh;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      height: 100%;
      overflow-x: hidden;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    /*
      ✅ Requested adaptive full-screen for Telegram Mini App
      Uses Telegram-provided CSS variables. Falls back gracefully on web.
    */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, 'Helvetica Neue', Arial, sans-serif;
      /* Use *stable* height to avoid iOS URL bar jumps inside Telegram */
      height: var(--tg-viewport-stable-height, 100vh);
      min-height: var(--tg-viewport-stable-height, 100vh);
      /* Respect safe areas (status bar, dynamic island, etc.) */
      padding-top: calc(var(--tg-safe-area-inset-top, 0px) + var(--tg-content-safe-area-inset-top, 0px) + 15px);
      padding-bottom: calc(var(--tg-safe-area-inset-bottom, 0px) + 12px);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* App Container — frameless (edge-to-edge), Uber-like minimal chrome */
    .app-container {
      height: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
      background: linear-gradient(180deg, var(--bg-primary), var(--bg-secondary));
    }

    /* Header — flat, bold typography, no heavy borders, subtle divider only */
    .header {
      background: linear-gradient(180deg, rgba(0,0,0,0.7), rgba(0,0,0,0.4));
      padding: 10px 16px 12px;
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      backdrop-filter: saturate(150%) blur(8px);
      -webkit-backdrop-filter: saturate(150%) blur(8px);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    .header-left { display: flex; align-items: center; gap: 12px; }
    .header-title {
      font-size: 22px;
      font-weight: 800;
      letter-spacing: 0.08em;
      color: var(--text-primary);
    }
    .header-subtitle { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

    .header-right { display: flex; align-items: center; gap: 10px; }

    /* Language Switch — pill with subtle outline */
    .lang-switch {
      background: rgba(255,255,255,0.04);
      border-radius: 999px;
      display: flex;
      padding: 4px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .lang-btn {
      padding: 6px 12px;
      border: none;
      background: transparent;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-muted);
    }
    .lang-btn.active { background: var(--text-primary); color: var(--lumen-black); }

    /* Cart Button — monochrome with subtle gold dot when items present */
    .cart-btn {
      position: relative;
      background: #121212;
      color: var(--text-primary);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 10px;
      border-radius: 12px;
      width: 44px; height: 44px;
      cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;
      transition: transform .15s ease, background .2s ease;
    }
    .cart-btn:active { transform: scale(0.97); }
    .cart-badge {
      position: absolute; top: -6px; right: -6px;
      background: var(--accent);
      color: #0a0a0a;
      border: 2px solid #0a0a0a;
      border-radius: 999px; width: 22px; height: 22px;
      font-size: 11px; font-weight: 800; display: flex; align-items: center; justify-content: center; min-width: 22px;
      box-shadow: var(--shadow-glow);
    }

    /* Search */
    .search-container { padding: 14px 16px 12px; background: transparent; }
    .search-wrapper { position: relative; }
    .search-input {
      width: 100%; padding: 12px 16px 12px 44px;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px; font-size: 16px; background: #111213; color: var(--text-primary);
      outline: none; transition: border-color .2s, box-shadow .2s, background .2s;
    }
    .search-input:focus { border-color: rgba(255,255,255,0.16); box-shadow: 0 0 0 6px rgba(255,255,255,0.04); background: #121315; }
    .search-input::placeholder { color: var(--text-muted); }
    .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); opacity: .9; }

    /* Filter Pills — flat, monochrome */
    .filter-container {
      padding: 2px 16px 12px; display: flex; gap: 8px; overflow-x: auto; -webkit-overflow-scrolling: touch;
    }
    .filter-pill {
      padding: 8px 14px; background: #111213; border: 1px solid rgba(255,255,255,0.08);
      border-radius: 999px; font-size: 13px; font-weight: 700; cursor: pointer; transition: background .2s, border-color .2s, color .2s; white-space: nowrap; flex-shrink: 0; color: var(--text-primary);
    }
    .filter-pill:hover { background: #151619; border-color: rgba(255,255,255,0.14); }
    .filter-pill.active { background: var(--text-primary); color: #0a0a0a; border-color: var(--text-primary); }

    /* Product List */
    .product-list { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; background: transparent; }
    .product-count { padding: 10px 16px; font-size: 13px; color: var(--text-muted); border-bottom: 1px solid rgba(255,255,255,0.06); backdrop-filter: blur(4px); }

    .product-item {
      display: flex; padding: 14px; border-bottom: 1px solid rgba(255,255,255,0.06);
      cursor: pointer; transition: background .25s, transform .2s ease;
      gap: 12px; background: transparent; margin: 0; border-radius: 0;
    }
    .product-item:hover { background: rgba(255,255,255,0.02); }
    .product-item:active { transform: scale(0.998); }

    .product-image { width: 84px; height: 84px; border-radius: 12px; background: #131415; flex-shrink: 0; border: 1px solid rgba(255,255,255,0.08); overflow: hidden; display: flex; align-items: center; justify-content: center; }
    .product-image img { width: 100%; height: 100%; object-fit: cover; border-radius: inherit; display: none; }
    .image-placeholder { font-size: 28px; color: var(--text-secondary); opacity: .9; }

    .product-info { flex: 1; display: flex; flex-direction: column; gap: 6px; }
    .product-name { font-size: 16px; font-weight: 800; color: var(--text-primary); line-height: 1.25; }
    .product-sex { font-size: 11px; color: #0a0a0a; background: var(--text-primary); padding: 2px 8px; border-radius: 999px; width: fit-content; font-weight: 800; }
    .product-description { font-size: 13px; color: var(--text-muted); line-height: 1.45; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

    .product-actions { display: flex; align-items: center; justify-content: space-between; margin-top: 6px; }
    .product-price { font-size: 18px; font-weight: 900; color: var(--text-primary); }
    .product-price-unit { font-size: 12px; font-weight: 500; color: var(--text-muted); }

    .add-btn {
      background: var(--text-primary); color: #0a0a0a; border: none; padding: 9px 14px; border-radius: 10px;
      font-size: 13px; font-weight: 800; cursor: pointer; transition: transform .14s ease, box-shadow .2s ease, background .2s; display: flex; align-items: center; gap: 6px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
    }
    .add-btn:hover { transform: translateY(-1px); }
    .add-btn:active { transform: translateY(0); }
    .product-cart-indicator { position: absolute; top: -8px; right: -8px; background: var(--accent); color: #0a0a0a; border: 2px solid #0a0a0a; border-radius: 999px; width: 24px; height: 24px; font-size: 12px; font-weight: 800; display: flex; align-items: center; justify-content: center; min-width: 24px; z-index: 5; box-shadow: var(--shadow-glow); }

    /* Modal — glassy, frameless */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.66); z-index: 100; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(8px); }
    .modal { background: rgba(20,20,22,0.88); border: 1px solid rgba(255,255,255,0.08); border-radius: 18px; width: 100%; max-width: 420px; max-height: 85vh; overflow: hidden; animation: modalSlideUp .28s ease; box-shadow: var(--shadow-lg); position: relative; }
    @keyframes modalSlideUp { from { transform: translateY(12px); opacity: .6;} to { transform: translateY(0); opacity: 1; } }
    .modal-header { position: relative; padding: 0; display: flex; justify-content: flex-end; }
    .modal-close { position: absolute; top: 12px; right: 12px; width: 36px; height: 36px; background: #121214; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; color: var(--text-primary); transition: background .2s; }
    .modal-close:hover { background: #18181b; }
    .modal-content { padding: 18px; max-height: calc(85vh - 44px); overflow-y: auto; -webkit-overflow-scrolling: touch; }
    .modal-image { width: 100%; height: 250px; border-radius: 14px; background: #121214; margin-bottom: 14px; border: 1px solid rgba(255,255,255,0.08); overflow: hidden; display: flex; align-items: center; justify-content: center; }
    .modal-image img { width: 100%; height: 100%; object-fit: cover; border-radius: inherit; display: none; }
    .modal-title { font-size: 20px; font-weight: 900; color: var(--text-primary); margin-bottom: 6px; line-height: 1.28; }
    .modal-sex { font-size: 12px; color: #0a0a0a; background: var(--text-primary); padding: 4px 10px; border-radius: 999px; display: inline-block; margin-bottom: 12px; font-weight: 900; }
    .modal-description { font-size: 15px; color: var(--text-muted); line-height: 1.55; margin-bottom: 18px; }
    .modal-price { font-size: 22px; font-weight: 900; color: var(--text-primary); margin-bottom: 14px; }
    .modal-add-btn { background: var(--text-primary); color: #0a0a0a; border: none; padding: 14px; border-radius: 12px; font-size: 15px; font-weight: 900; cursor: pointer; width: 100%; transition: transform .14s ease; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.35); }
    .modal-add-btn:active { transform: scale(0.98); }

    /* Cart Panel — bottom sheet on mobile, side panel on desktop */
    .cart-panel { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(20,20,22,0.98); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px 16px 0 0; box-shadow: var(--shadow-lg); z-index: 50; transform: translateY(100%); transition: transform .28s cubic-bezier(.4,0,.2,1); max-height: 60vh; display: flex; flex-direction: column; backdrop-filter: blur(8px); }
    .cart-panel.show { transform: translateY(0); }
    .cart-handle { width: 40px; height: 4px; background: rgba(255,255,255,0.24); border-radius: 2px; margin: 8px auto; }
    .cart-header { padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.08); display: flex; align-items: center; justify-content: space-between; }
    .cart-title { font-size: 18px; font-weight: 900; }
    .cart-subtitle { font-size: 13px; color: var(--text-muted); }
    .cart-close { width: 36px; height: 36px; background: #121214; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; color: var(--text-primary); transition: background .2s; }
    .cart-close:hover { background: #18181b; }

    .cart-items { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 0 16px; }
    .cart-item { display: flex; align-items: center; padding: 14px 0; border-bottom: 1px solid rgba(255,255,255,0.06); gap: 12px; }
    .cart-item:last-child { border-bottom: none; }
    .cart-item-image { width: 52px; height: 52px; border-radius: 10px; background: #121214; flex-shrink: 0; border: 1px solid rgba(255,255,255,0.08); overflow: hidden; display: flex; align-items: center; justify-content: center; }
    .cart-item-image img { width: 100%; height: 100%; object-fit: cover; border-radius: inherit; }
    .cart-item-info { flex: 1; min-width: 0; }
    .cart-item-name { font-size: 14px; font-weight: 800; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .cart-item-price { font-size: 14px; color: var(--text-primary); }
    .cart-item-controls { display: flex; align-items: center; gap: 12px; }
    .quantity-controls { display: flex; align-items: center; gap: 8px; }
    .quantity-btn { width: 30px; height: 30px; background: #121214; border: 1px solid rgba(255,255,255,0.12); border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 800; transition: transform .1s ease; color: var(--text-primary); }
    .quantity-btn:active { transform: scale(0.95); }
    .quantity-value { font-size: 14px; font-weight: 800; min-width: 22px; text-align: center; color: var(--text-primary); }

    .cart-footer { padding: 14px 16px calc(14px + var(--tg-safe-area-inset-bottom, 0px)); border-top: 1px solid rgba(255,255,255,0.08); background: rgba(16,16,18,0.98); backdrop-filter: blur(6px); }
    .cart-total { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .cart-total-label { font-size: 14px; color: var(--text-muted); }
    .cart-total-value { font-size: 20px; font-weight: 900; color: var(--text-primary); }
    .order-btn { background: var(--text-primary); color: #0a0a0a; border: none; padding: 14px; border-radius: 12px; font-size: 15px; font-weight: 900; cursor: pointer; width: 100%; transition: transform .12s ease; box-shadow: 0 8px 24px rgba(0,0,0,0.35); }
    .order-btn:active { transform: scale(0.98); }

    /* Loading & Empty */
    .loading { display: flex; align-items: center; justify-content: center; padding: 40px; color: var(--text-secondary); }
    .loading-spinner { width: 28px; height: 28px; border: 3px solid rgba(255,255,255,0.12); border-top-color: var(--text-primary); border-radius: 50%; animation: spin .8s linear infinite; margin-right: 12px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; text-align: center; }
    .empty-icon { font-size: 56px; margin-bottom: 12px; opacity: 0.75; }
    .empty-title { font-size: 18px; font-weight: 900; margin-bottom: 6px; }
    .empty-subtitle { font-size: 14px; color: var(--text-muted); }

    /* Quick Order Button — floating CTA */
    .quick-order-btn { position: fixed; bottom: calc(16px + var(--tg-safe-area-inset-bottom, 0px)); left: 16px; right: 16px; background: var(--text-primary); color: #0a0a0a; border: none; padding: 14px; border-radius: 14px; font-size: 15px; font-weight: 900; cursor: pointer; z-index: 40; box-shadow: 0 14px 36px rgba(0,0,0,0.5); transition: transform .28s ease, opacity .28s ease; transform: translateY(120px); opacity: 0; }
    .quick-order-btn.show { transform: translateY(0); opacity: 1; }
    .quick-order-btn:active { transform: translateY(0) scale(0.98); }

    /* Utilities */
    .hidden { display: none !important; }

    /* Responsive tweaks */
    @media (max-width: 480px) {
      .header { padding: 10px 16px 10px; }
      .header-title { font-size: 20px; }
      .product-image { width: 76px; height: 76px; }
      .modal { width: 95%; max-width: 95%; max-height: 90vh; border-radius: 18px; }
      .modal-content { padding: 16px; max-height: calc(90vh - 60px); }
      .modal-image { height: 260px; }
      .cart-panel { max-height: 75vh; }
    }

    @media (min-width: 768px) and (max-width: 1023px) {
      .app-container { max-width: 100%; margin: 0 auto; }
      .header { padding: 16px 24px; }
      .search-container { padding: 16px 24px 12px; }
      .filter-container { padding: 0 24px 12px; }
      .product-list { padding: 0 8px; }
      .product-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; padding: 10px 8px 16px; }
      .product-item { flex-direction: column; border-bottom: none; border-radius: 14px; padding: 12px; background: #111213; border: 1px solid rgba(255,255,255,0.06); }
      .product-image { width: 100%; height: 140px; margin-bottom: 10px; }

      /* Tablet cart as centered sheet */
      .cart-panel { top: 50%; left: 50%; right: auto; bottom: auto; width: 92%; max-width: 520px; max-height: 70vh; border-radius: 16px; transform: translate(-50%, 40px); opacity: 0; }
      .cart-panel.show { transform: translate(-50%, -50%); opacity: 1; }
      .modal { max-width: 520px; }
    }

    @media (min-width: 1024px) {
      .app-container { max-width: 1200px; margin: 0 auto; min-height: 100vh; }
      .header { padding: 18px 28px; }
      .search-container { padding: 18px 28px 12px; }
      .filter-container { padding: 0 28px 12px; justify-content: flex-start; }
      .product-list { padding: 0 12px; }
      .product-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; padding: 10px 12px 18px; }
      .product-item { flex-direction: column; border-bottom: none; border-radius: 16px; padding: 14px; background: #111213; border: 1px solid rgba(255,255,255,0.06); transition: transform .2s ease, box-shadow .2s ease; }
      .product-item:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
      .product-image { width: 100%; height: 160px; margin-bottom: 12px; }
      .product-actions { flex-direction: column; gap: 10px; align-items: stretch; }
      .add-btn { justify-content: center; padding: 11px 16px; }

      /* Side cart */
      .cart-panel { top: 74px; right: -420px; left: auto; bottom: auto; width: 400px; max-width: 400px; max-height: calc(100vh - 110px); border-radius: 16px; transform: none; transition: right .28s ease; }
      .cart-panel.show { right: 20px; }
      .quick-order-btn { display: none; }
      .modal { max-width: 600px; max-height: 70vh; }
      .modal-image { height: 300px; }
      .product-count { text-align: left; padding: 12px; font-size: 14px; grid-column: 1 / -1; }
    }

    @media (min-width: 1400px) {
      .app-container { max-width: 1400px; }
      .product-grid { grid-template-columns: repeat(4, 1fr); gap: 18px; }
      .cart-panel { width: 440px; max-width: 440px; }
    }

    /* High-DPI */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
      .product-image, .cart-item-image, .modal-image { image-rendering: -webkit-optimize-contrast; image-rendering: crisp-edges; }
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--uber-gray-400); border-radius: 2px; }
  </style>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <div>
          <div class="header-title" id="headerTitle">ZHAD</div>
          <div class="header-subtitle" id="headerSubtitle">Парфюм каталогы</div>
        </div>
      </div>
      <div class="header-right">
        <div class="lang-switch">
          <button class="lang-btn" id="langRu" onclick="setLanguage('ru')">РУС</button>
          <button class="lang-btn active" id="langKz" onclick="setLanguage('kz')">ҚАЗ</button>
        </div>
        <button class="cart-btn" onclick="toggleCart()">
          🛒
          <span class="cart-badge hidden" id="cartBadge">0</span>
        </button>
      </div>
    </div>

    <!-- Search -->
    <div class="search-container">
      <div class="search-wrapper">
        <span class="search-icon">🔍</span>
        <input type="text" class="search-input" id="searchInput" placeholder="Парфюм іздеу..." />
      </div>
    </div>

    <!-- Filters -->
    <div class="filter-container">
      <button class="filter-pill active" onclick="setFilter('all')" id="filterAll">Барлығы</button>
      <button class="filter-pill" onclick="setFilter('Male')" id="filterMale">Ерлерге</button>
      <button class="filter-pill" onclick="setFilter('Female')" id="filterFemale">Әйелдерге</button>
      <button class="filter-pill" onclick="setFilter('Unisex')" id="filterUnisex">Барлығына</button>
    </div>

    <!-- Product List -->
    <div class="product-list" id="productList">
      <div class="loading">
        <div class="loading-spinner"></div>
        <span id="loadingText">Парфюмдер жүктелуде...</span>
      </div>
    </div>

    <!-- Quick Order Button -->
    <button class="quick-order-btn" id="quickOrderBtn" onclick="proceedToOrder()">
      <span id="orderBtnText">Тапсырыс беру</span> • <span id="orderBtnTotal">0 ₸</span>
    </button>

    <!-- Product Detail Modal -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
          <button class="modal-close" onclick="closeModal()">✕</button>
        </div>
        <div class="modal-content" id="modalContent"><!-- Dynamic content --></div>
      </div>
    </div>

    <!-- Cart Panel -->
    <div class="cart-panel" id="cartPanel">
      <div class="cart-handle"></div>
      <div class="cart-header">
        <div class="cart-header-left">
          <h2 class="cart-title" id="cartTitle">Себет</h2>
          <p class="cart-subtitle" id="cartSubtitle">Таңдалған парфюмдер</p>
        </div>
        <button class="cart-close" onclick="toggleCart()">✕</button>
      </div>
      <div class="cart-items" id="cartItems"><!-- Dynamic cart items --></div>
      <div class="cart-footer">
        <div class="cart-total">
          <span class="cart-total-label" id="totalLabel">Барлығы:</span>
          <span class="cart-total-value" id="totalValue">0 ₸</span>
        </div>
        <button class="order-btn" onclick="proceedToOrder()" id="cartOrderBtn">Тапсырыс беру</button>
      </div>
    </div>
  </div>

  <script>
    // Global Variables (logic unchanged)
    let currentLang = 'kz';
    let allPerfumes = [];
    let filteredPerfumes = [];
    let cart = [];
    let telegramId = null;
    let isCartOpen = false;
    let currentFilter = 'all';

    // Translations (unchanged)
    const translations = {
      ru: { title:'ZHAD PARFUME', subtitle:'Каталог парфюмерии', searchPlaceholder:'Поиск парфюма...', loadingText:'Загрузка парфюмов...', filterAll:'Все', filterMale:'Для мужчин', filterFemale:'Для женщин', filterUnisex:'Унисекс', addToCart:'В корзину', cartTitle:'Корзина', cartSubtitle:'Выбранные парфюмы', totalLabel:'Итого:', orderBtnText:'Оформить заказ', emptyCartTitle:'Корзина пуста', emptyCartSubtitle:'Добавьте парфюмы для заказа', emptySearchTitle:'Ничего не найдено', emptySearchSubtitle:'Попробуйте изменить поисковый запрос', items:'товаров', male:'Мужской', female:'Женский', unisex:'Унисекс', tenge:'₸' },
      kz: { title:'ZHAD PARFUME', subtitle:'Парфюм каталогы', searchPlaceholder:'Парфюм іздеу...', loadingText:'Парфюмдер жүктелуде...', filterAll:'Барлығы', filterMale:'Ерлерге', filterFemale:'Әйелдерге', filterUnisex:'Барлығына', addToCart:'Себетке', cartTitle:'Себет', cartSubtitle:'Таңдалған парфюмдер', totalLabel:'Барлығы:', orderBtnText:'Тапсырыс беру', emptyCartTitle:'Себет бос', emptyCartSubtitle:'Тапсырыс беру үшін парфюм қосыңыз', emptySearchTitle:'Ештеңе табылмады', emptySearchSubtitle:'Іздеу сөзін өзгертіп көріңіз', items:'тауар', male:'Ерлер', female:'Әйелдер', unisex:'Барлығына', tenge:'₸' }
    };

    // Telegram WebApp init (logic unchanged; expanded to use safe viewport vars)
    function initTelegramWebApp() {
      if (!window.Telegram || !Telegram.WebApp) return false;
      try {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        if (Telegram.WebApp.initDataUnsafe?.user) {
          telegramId = Telegram.WebApp.initDataUnsafe.user.id;
        }
        try {
          Telegram.WebApp.setBackgroundColor('#0b0b0b');
          Telegram.WebApp.setHeaderColor('#000000');
        } catch (_) {}
        updateViewportHeight();
        Telegram.WebApp.onEvent('viewportChanged', updateViewportHeight);
        return true;
      } catch (e) {
        console.error('Telegram init error', e);
        return false;
      }
    }

    // Update viewport height CSS var (kept for compatibility)
    function updateViewportHeight() {
      let vh = window.innerHeight;
      if (window.Telegram && Telegram.WebApp) vh = Telegram.WebApp.viewportHeight || vh;
      document.documentElement.style.setProperty('--tg-viewport-height', `${vh}px`);
    }

    // Load perfumes from API (unchanged)
    async function loadPerfumes() {
      try {
        const response = await fetch('/api/parfumes');
        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        allPerfumes = await response.json();
        filteredPerfumes = [...allPerfumes];
        renderPerfumes();
      } catch (error) {
        console.error('Error loading perfumes:', error);
        showEmptyState('error', 'Қате орын алды', 'Парфюмдерді жүктеу мүмкін болмады');
      }
    }

    function getCartQuantity(productId) {
      const item = cart.find(item => item.id === productId);
      return item ? item.quantity : 0;
    }

    // Render list/grid (unchanged logic)
    function renderPerfumes() {
      const container = document.getElementById('productList');
      if (filteredPerfumes.length === 0) { showEmptyState('search'); return; }
      const isLargeScreen = window.innerWidth >= 768;

      if (isLargeScreen) {
        let html = `<div class="product-grid">`;
        html += `<div class="product-count">${filteredPerfumes.length} ${translations[currentLang].items}</div>`;
        filteredPerfumes.forEach(perfume => {
          const photoUrl = perfume.PhotoPath ? `/photo/${perfume.PhotoPath}` : null;
          const sexLabel = getSexLabel(perfume.Sex);
          const cartQuantity = getCartQuantity(perfume.Id);
          const imageHtml = photoUrl ? `<img src="${photoUrl}" alt="${escapeHtml(perfume.NameParfume)}" onload="this.style.display='block'" onerror="handleImageError(this)">` : '<div class="image-placeholder">🌸</div>';
          html += `
            <div class="product-item" onclick="showProductDetail('${perfume.Id}')">
              <div class="product-image">${imageHtml}</div>
              <div class="product-info">
                <div class="product-name">${escapeHtml(perfume.NameParfume)}</div>
                <span class="product-sex">${sexLabel}</span>
                <div class="product-description">${escapeHtml(perfume.Description)}</div>
                <div class="product-actions">
                  <div class="product-price">${perfume.Price} <span class="product-price-unit">${translations[currentLang].tenge}</span></div>
                  <button class="add-btn" onclick="event.stopPropagation(); addToCart('${perfume.Id}')">
                    ➕ ${translations[currentLang].addToCart}
                    ${cartQuantity > 0 ? `<span class="product-cart-indicator">${cartQuantity}</span>` : ''}
                  </button>
                </div>
              </div>
            </div>`;
        });
        html += `</div>`;
        container.innerHTML = html;
      } else {
        let html = `<div class="product-count">${filteredPerfumes.length} ${translations[currentLang].items}</div>`;
        filteredPerfumes.forEach(perfume => {
          const photoUrl = perfume.PhotoPath ? `/photo/${perfume.PhotoPath}` : null;
          const sexLabel = getSexLabel(perfume.Sex);
          const cartQuantity = getCartQuantity(perfume.Id);
          const imageHtml = photoUrl ? `<img src="${photoUrl}" alt="${escapeHtml(perfume.NameParfume)}" onload="this.style.display='block'" onerror="handleImageError(this)">` : '<div class="image-placeholder">🌸</div>';
          html += `
            <div class="product-item" onclick="showProductDetail('${perfume.Id}')">
              <div class="product-image">${imageHtml}</div>
              <div class="product-info">
                <div class="product-name">${escapeHtml(perfume.NameParfume)}</div>
                <span class="product-sex">${sexLabel}</span>
                <div class="product-description">${escapeHtml(perfume.Description)}</div>
                <div class="product-actions">
                  <div class="product-price">${perfume.Price} <span class="product-price-unit">${translations[currentLang].tenge}</span></div>
                  <button class="add-btn" onclick="event.stopPropagation(); addToCart('${perfume.Id}')">
                    ➕ ${translations[currentLang].addToCart}
                    ${cartQuantity > 0 ? `<span class="product-cart-indicator">${cartQuantity}</span>` : ''}
                  </button>
                </div>
              </div>
            </div>`;
        });
        container.innerHTML = html;
      }
    }

    function showEmptyState(type, customTitle = null, customSubtitle = null) {
      const container = document.getElementById('productList');
      let icon, title, subtitle;
      if (type === 'search') { icon = '🔍'; title = customTitle || translations[currentLang].emptySearchTitle; subtitle = customSubtitle || translations[currentLang].emptySearchSubtitle; }
      else if (type === 'error') { icon = '⚠️'; title = customTitle || 'Қате орын алды'; subtitle = customSubtitle || 'Парфюмдерді жүктеу мүмкін болмады'; }
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">${icon}</div>
          <div class="empty-title">${title}</div>
          <div class="empty-subtitle">${subtitle}</div>
        </div>`;
    }

    function getSexLabel(sex) {
      const labels = { 'Male': translations[currentLang].male, 'Female': translations[currentLang].female, 'Unisex': translations[currentLang].unisex };
      return labels[sex] || sex;
    }

    function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

    function setFilter(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-pill').forEach(btn => btn.classList.remove('active'));
      event.currentTarget.classList.add('active');
      if (filter === 'all') filteredPerfumes = [...allPerfumes]; else filteredPerfumes = allPerfumes.filter(p => p.Sex === filter);
      const searchTerm = document.getElementById('searchInput').value.trim();
      if (searchTerm) { searchPerfumes(searchTerm); } else { renderPerfumes(); }
    }

    function searchPerfumes(query) {
      const searchTerm = query.toLowerCase();
      const baseList = currentFilter === 'all' ? allPerfumes : allPerfumes.filter(p => p.Sex === currentFilter);
      filteredPerfumes = baseList.filter(perfume => (perfume.NameParfume || '').toLowerCase().includes(searchTerm) || (perfume.Description || '').toLowerCase().includes(searchTerm));
      renderPerfumes();
    }

    function showProductDetail(productId) {
      const perfume = allPerfumes.find(p => p.Id === productId);
      if (!perfume) return;
      const photoUrl = perfume.PhotoPath ? `/photo/${perfume.PhotoPath}` : null;
      const sexLabel = getSexLabel(perfume.Sex);
      const modalContent = document.getElementById('modalContent');
      const imageHtml = photoUrl ? `<img src="${photoUrl}" alt="${escapeHtml(perfume.NameParfume)}" onload="this.style.display='block'" onerror="handleImageError(this)">` : '<div class="image-placeholder">🌸</div>';
      modalContent.innerHTML = `
        <div class="modal-image">${imageHtml}</div>
        <h2 class="modal-title">${escapeHtml(perfume.NameParfume)}</h2>
        <span class="modal-sex">${sexLabel}</span>
        <p class="modal-description">${escapeHtml(perfume.Description)}</p>
        <div class="modal-price">${perfume.Price} ${translations[currentLang].tenge}</div>
        <button class="modal-add-btn" onclick="addToCart('${perfume.Id}'); closeModal();">➕ ${translations[currentLang].addToCart}</button>`;
      document.getElementById('modalOverlay').style.display = 'flex';
    }

    function handleImageError(img) { const container = img.parentElement; container.innerHTML = '<div class="image-placeholder">🌸</div>'; }
    function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }

    function addToCart(productId) {
      const perfume = allPerfumes.find(p => p.Id === productId);
      if (!perfume) return;
      const existingItem = cart.find(item => item.id === productId);
      if (existingItem) existingItem.quantity += 1; else cart.push({ id: productId, name: perfume.NameParfume, price: perfume.Price, photo: perfume.PhotoPath, quantity: 1 });
      updateCartUI();
      const btn = event.currentTarget; const originalText = btn.innerHTML; btn.innerHTML = '✓ Қосылды'; btn.style.background = 'var(--uber-green)';
      setTimeout(() => { btn.innerHTML = originalText; btn.style.background = ''; }, 900);
    }

    function updateCartUI() {
      const cartBadge = document.getElementById('cartBadge');
      const quickOrderBtn = document.getElementById('quickOrderBtn');
      const totalItems = cart.reduce((s, i) => s + i.quantity, 0);
      const totalPrice = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
      if (totalItems > 0) {
        cartBadge.textContent = totalItems; cartBadge.classList.remove('hidden');
        quickOrderBtn.classList.add('show');
        document.getElementById('orderBtnTotal').textContent = `${totalPrice} ${translations[currentLang].tenge}`;
      } else {
        cartBadge.classList.add('hidden'); quickOrderBtn.classList.remove('show');
      }
      if (isCartOpen) renderCart();
    }

    function toggleCart() {
      isCartOpen = !isCartOpen; const cartPanel = document.getElementById('cartPanel');
      if (isCartOpen) {
        cartPanel.classList.add('show'); renderCart();
        if (window.innerWidth < 1024) {
          const overlay = document.createElement('div'); overlay.id = 'cart-backdrop'; overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:40;'; overlay.onclick = () => toggleCart(); document.body.appendChild(overlay);
        }
      } else {
        cartPanel.classList.remove('show'); const overlay = document.getElementById('cart-backdrop'); if (overlay) overlay.remove();
      }
    }

    function renderCart() {
      const cartItems = document.getElementById('cartItems');
      const totalValue = document.getElementById('totalValue');
      const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      totalValue.textContent = `${totalPrice} ${translations[currentLang].tenge}`;
      if (cart.length === 0) {
        cartItems.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">🛒</div>
            <div class="empty-title">${translations[currentLang].emptyCartTitle}</div>
            <div class="empty-subtitle">${translations[currentLang].emptyCartSubtitle}</div>
          </div>`; return;
      }
      let html = '';
      cart.forEach(item => {
        const photoUrl = item.photo ? `/photo/${item.photo}` : null;
        html += `
          <div class="cart-item">
            <div class="cart-item-image">${photoUrl ? `<img src="${photoUrl}" alt="${escapeHtml(item.name)}" onerror="this.parentElement.innerHTML='🌸'; this.parentElement.style.fontSize='24px';">` : '<span style="font-size:24px;">🌸</span>'}</div>
            <div class="cart-item-info">
              <div class="cart-item-name">${escapeHtml(item.name)}</div>
              <div class="cart-item-price">${item.price} ${translations[currentLang].tenge}</div>
            </div>
            <div class="cart-item-controls">
              <div class="quantity-controls">
                <button class="quantity-btn" onclick="updateQuantity('${item.id}', -1)">−</button>
                <span class="quantity-value">${item.quantity}</span>
                <button class="quantity-btn" onclick="updateQuantity('${item.id}', 1)">+</button>
              </div>
            </div>
          </div>`;
      });
      cartItems.innerHTML = html;
    }

    function updateQuantity(productId, change) {
      const item = cart.find(i => i.id === productId); if (!item) return;
      item.quantity += change; if (item.quantity <= 0) cart = cart.filter(ci => ci.id !== productId);
      updateCartUI(); renderPerfumes();
    }

    function proceedToOrder() {
      if (cart.length === 0) {
        if (window.Telegram && Telegram.WebApp) Telegram.WebApp.showAlert(translations[currentLang].emptyCartTitle); else alert(translations[currentLang].emptyCartTitle);
        return;
      }
      const orderData = { telegram_id: telegramId, cart: cart, total: cart.reduce((s, i) => s + (i.price * i.quantity), 0), timestamp: Date.now() };
      try { sessionStorage.setItem('lumenOrder', JSON.stringify(orderData)); window.location.href = './order'; }
      catch (e) { console.error('Order save error:', e); if (window.Telegram && Telegram.WebApp) Telegram.WebApp.showAlert('Қате орын алды. Қайталап көріңіз.'); else alert('Қате орын алды. Қайталап көріңіз.'); }
    }

    function setLanguage(lang) {
      currentLang = lang;
      document.getElementById('langRu').classList.toggle('active', lang === 'ru');
      document.getElementById('langKz').classList.toggle('active', lang === 'kz');
      document.getElementById('headerTitle').textContent = translations[lang].title;
      document.getElementById('headerSubtitle').textContent = translations[lang].subtitle;
      document.getElementById('searchInput').placeholder = translations[lang].searchPlaceholder;
      document.getElementById('loadingText').textContent = translations[lang].loadingText;
      document.getElementById('orderBtnText').textContent = translations[lang].orderBtnText;
      document.getElementById('cartTitle').textContent = translations[lang].cartTitle;
      document.getElementById('cartSubtitle').textContent = translations[lang].cartSubtitle;
      document.getElementById('totalLabel').textContent = translations[lang].totalLabel;
      document.getElementById('cartOrderBtn').textContent = translations[lang].orderBtnText;
      document.getElementById('filterAll').textContent = translations[lang].filterAll;
      document.getElementById('filterMale').textContent = translations[lang].filterMale;
      document.getElementById('filterFemale').textContent = translations[lang].filterFemale;
      document.getElementById('filterUnisex').textContent = translations[lang].filterUnisex;
      if (filteredPerfumes.length > 0) renderPerfumes();
      if (isCartOpen) renderCart();
      updateCartUI();
    }

    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('searchInput');
      let searchTimeout;
      searchInput.addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();
        searchTimeout = setTimeout(() => {
          if (query.length === 0) {
            filteredPerfumes = currentFilter === 'all' ? [...allPerfumes] : allPerfumes.filter(p => p.Sex === currentFilter);
          } else { searchPerfumes(query); }
          renderPerfumes();
        }, 300);
      });
    });

    document.addEventListener('click', function(e) {
      const cartPanel = document.getElementById('cartPanel');
      const cartBtn = document.querySelector('.cart-btn');
      if (isCartOpen && !cartPanel.contains(e.target) && !cartBtn.contains(e.target) && !e.target.classList.contains('quantity-btn') && !e.target.closest('.quantity-controls')) {
        toggleCart();
      }
    });

    document.addEventListener('DOMContentLoaded', function() {
      const cartPanel = document.getElementById('cartPanel');
      if (cartPanel) { cartPanel.addEventListener('click', function(e) { e.stopPropagation(); }); }
    });

    async function init() {
      initTelegramWebApp();
      setLanguage('kz');
      await loadPerfumes();
      window.addEventListener('resize', function() { updateViewportHeight(); renderPerfumes(); });
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') { if (document.getElementById('modalOverlay').style.display === 'flex') closeModal(); else if (isCartOpen) toggleCart(); }
    });

    // Prevent double-tap zoom
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(e) {
      const now = Date.now(); if (now - lastTouchEnd <= 300) { e.preventDefault(); }
      lastTouchEnd = now;
    }, { passive: false });
  </script>
</body>
</html>